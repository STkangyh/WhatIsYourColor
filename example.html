<div>Teachable Machine Image Model</div>
<button type="button" onclick="startPredict()">Start</button>
<button type="button" onclick="stopPredict()">Stop</button>
<div id="webcam-container"></div>
<div id="label-container" style="font-size: 24px;"></div>

<audio id="applause" preload="auto">
    <source src="applause.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
</audio>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
<script type="text/javascript">
    const URL = "./my_model/";

    let model, webcam, labelContainer, maxPredictions, isPredicting = false;

    async function startPredict() {
        if (!isPredicting) {
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";

            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();

            const flip = true;
            webcam = new tmImage.Webcam(200, 200, flip);
            await webcam.setup();
            await webcam.play();
            window.requestAnimationFrame(loop);

            document.getElementById("webcam-container").appendChild(webcam.canvas);
            labelContainer = document.getElementById("label-container");
            isPredicting = true;
        }
    }

    async function stopPredict() {
        if (webcam && isPredicting) {
            webcam.stop();
            isPredicting = false;
            await predict(); // Display prediction after stopping
            playApplauseSound(); // Play applause sound
            expandAndContractImage();
        }
    }

    async function loop() {
        if (isPredicting) {
            webcam.update();
            await predict();
            window.requestAnimationFrame(loop);
        }
    }

    async function predict() {
        const prediction = await model.predict(webcam.canvas);
        let highestProbability = 0;
        let predictedClass = '';

        for (let i = 0; i < maxPredictions; i++) {
            if (prediction[i].probability > highestProbability) {
                highestProbability = prediction[i].probability;
                predictedClass = prediction[i].className;
            }
        }

        if (!isPredicting) {
            labelContainer.innerHTML = `예측 결과: ${predictedClass}`; // Display prediction after stopping
        } else {
            labelContainer.innerHTML = `축하합니다!<br>예측된 클래스: ${predictedClass}`;
        }
    }

    function playApplauseSound() {
        const applauseSound = document.getElementById('applause');
        applauseSound.play();
    }

    async function expandAndContractImage() {
        const webcamContainer = document.getElementById('webcam-container');
        const initialWidth = webcamContainer.offsetWidth;
        const initialHeight = webcamContainer.offsetHeight;
        const scaleFactor = 1.5; // Scale factor for image size

        for (let i = 0; i < 5; i++) {
            await new Promise((resolve) => setTimeout(resolve, 500)); // Delay before each change

            // Expand image
            webcamContainer.style.width = `${initialWidth * scaleFactor}px`;
            webcamContainer.style.height = `${initialHeight * scaleFactor}px`;

            await new Promise((resolve) => setTimeout(resolve, 500)); // Delay before contracting

            // Contract image
            webcamContainer.style.width = `${initialWidth}px`;
            webcamContainer.style.height = `${initialHeight}px`;
        }
    }
</script>
